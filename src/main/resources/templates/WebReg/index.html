<!DOCTYPE html>
<html lang="en"
      th:replace="~{default :: layout(~{:: meta}, ~{:: title}, ~{:: 'th:block'})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WebReg - Waffle</title>
</head>
<body>
<th:block>
    <h1>WebReg</h1>
    <form method="post"
          th:action="@{/WebReg}"
          th:object="${createForm}">
        <div class="c_Table"
             id="form">
            <table>
                <colgroup>
                    <col style="width: 30%;">
                    <col style="width: 20%;">
                    <col style="width: 30%;">
                    <col style="width: 20%;">
                </colgroup>
                <thead>
                <tr>
                    <th colspan="2">Expected</th>
                    <th colspan="2">Actual</th>
                </tr>
                <tr>
                    <th>URL</th>
                    <th>Delay (ms)</th>
                    <th>URL</th>
                    <th>Delay (ms)</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(item, idx) in form.cases"
                    :key="item.key">
                    <td>
                        <input aria-label="Expected URL"
                               class="c_Input"
                               type="text"
                               v-model="item.expected.resource"
                               :name="filter(idx, 'cases[' + idx + '].expected.resource')"
                               @focus="rearrange([idx])"
                               @input="rearrange([idx])">
                        <div v-for="err in errors['cases[' + idx + '].expected.resource']">{{ err }}</div>
                    </td>
                    <td>
                        <input aria-label="Expected Delay (ms)"
                               class="c_Input"
                               type="text"
                               v-model="item.expected.delayMs"
                               :name="filter(idx, 'cases[' + idx + '].expected.delayMs')"
                               @focus="rearrange([idx])"
                               @input="rearrange([idx])">
                        <div v-for="err in errors['cases[' + idx + '].expected.delayMs']">{{ err }}</div>
                    </td>
                    <td>
                        <input aria-label="Actual URL"
                               class="c_Input"
                               type="text"
                               v-model="item.actual.resource"
                               :name="filter(idx, 'cases[' + idx + '].actual.resource')"
                               @focus="rearrange([idx])"
                               @input="rearrange([idx])">
                        <div v-for="err in errors['cases[' + idx + '].actual.resource']">{{ err }}</div>
                    </td>
                    <td>
                        <input aria-label="Actual Delay (ms)"
                               class="c_Input"
                               type="text"
                               v-model="item.actual.delayMs"
                               :name="filter(idx, 'cases[' + idx + '].actual.delayMs')"
                               @focus="rearrange([idx])"
                               @input="rearrange([idx])">
                        <div v-for="err in errors['cases[' + idx + '].actual.delayMs']">{{ err }}</div>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="u_ta-r">
                <button @click="rearrange([])"
                        class="c_Button"
                        type="submit">Submit
                </button>
            </div>
        </div>
        <script th:src="@{/Scripts/vue.global.prod.js}"></script>
        <script th:inline="javascript">
            Vue.createApp({
                data() {
                    const keys = [
                        "expected.resource",
                        "expected.delayMs",
                        "actual.resource",
                        "actual.delayMs",
                    ];

                    const form = [[${createForm}]];
                    form.cases.forEach((item) => {
                        item.key = Math.random();
                    });

                    const errors = {};
                    [# th:each="err : ${#fields.detailedErrors()}"]
                        errors[ [[${err.fieldName}]] ] ||= [];
                        errors[ [[${err.fieldName}]] ].push([[${err.message}]]);
                    [/]

                    return {
                        keys: keys,
                        form: form,
                        errors: errors,
                    };
                },

                methods: {
                    filter(idx, value) {
                        return idx === 0 || idx < this.form.cases.length - 1 ? value : null;
                    },

                    get(obj, key) {
                        return key.split(".").reduce((v, k) => v[k], obj);
                    },

                    rearrange(idxes) {
                        this.form.cases = this.form.cases.filter((item, idx) => {
                            return idxes.includes(idx) || this.keys.some(key => this.get(item, key) !== "");
                        });

                        if (this.form.cases.length === 0
                            || this.keys.some(key => this.get(this.form.cases.at(-1), key) !== "")) {
                            const obj = {
                                key: Math.random(),
                            };

                            this.keys.forEach((key) => {
                                this.set(obj, key, "");
                            });

                            this.form.cases.push(obj);
                        }
                    },

                    set(obj, key, value) {
                        key.split(".").slice(0, -1).reduce((v, k) => v[k] ||= {}, obj)[key.split(".").at(-1)] = value;
                    },
                },

                created() {
                    this.rearrange(this.form.cases.map((_, idx) => idx));
                },
            }).mount("#form");
        </script>
    </form>
</th:block>
</body>
</html>
